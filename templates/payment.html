{% extends "base.html" %}
<!-- This template extends the base layout to reuse common elements (e.g., header, footer) -->

{% block head %}
    <!-- Set the title of the page (this could override the base title if necessary) -->
    <title>Payment</title>
    
    <!-- Include the Razorpay Checkout script from Razorpay's CDN -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Link to the page-specific CSS file for payment page styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/payment.css') }}">
{% endblock %}

{% block content %}
<!-- Main container for the payment section -->
<div class="payment-container">
    <!-- Heading for the payment page -->
    <h2>Confirm Your Payment</h2>
    
    <!-- Display product details dynamically -->
    <p><strong>Product:</strong> {{ product.name }}</p>
    <p><strong>Quantity:</strong> {{ order.quantity }}</p>
    <!-- Display final total price from the orders table -->
    <p><strong>Total Price:</strong> â‚¹{{ '%.2f'|format(order.total_price) }}</p>
    <p><strong>Shipping to:</strong> {{ order.address }}</p>

    <!-- Button to trigger the payment process -->
    <button id="rzp-button1" class="pay-btn">Pay Now</button>
</div>

<!-- Payment processing script using Razorpay Checkout -->
<script>
    // Options for the Razorpay checkout
    var options = {
        "key": "{{ razorpay_key }}",  // Razorpay API key provided by the backend
        // Use the order's total_price for the amount in paise:
        "amount": "{{ (order.total_price * 100)|int }}",  
        "currency": "INR",            
        "name": "My Store",           
        // Description with product name and quantity
        "description": "Purchase of {{ product.name }} x {{ order.quantity }}",  
        "order_id": "{{ razorpay_order_id }}",  
        "handler": function (response) {
            // This callback function is executed after a successful payment
            var orderId = "{{ order.id }}";  // Retrieve the order id from the backend
            // Create a form element to post payment details to the server for verification
            var form = document.createElement("form");
            form.method = "POST";
            form.action = "/payment_success/" + orderId;

            // Prepare payment details to be sent in the form
            var inputs = {
                "razorpay_payment_id": response.razorpay_payment_id,
                "razorpay_order_id": response.razorpay_order_id,
                "razorpay_signature": response.razorpay_signature
            };

            // Dynamically create hidden input fields for each payment detail
            for (var key in inputs) {
                var input = document.createElement("input");
                input.type = "hidden";
                input.name = key;
                input.value = inputs[key];
                form.appendChild(input);
            }

            // Append the form to the document body and submit it
            document.body.appendChild(form);
            form.submit();
        }
    };

    // Create a new Razorpay instance with the specified options
    var rzp1 = new Razorpay(options);
    
    // Attach an event listener to the "Pay Now" button to open the Razorpay checkout
    document.getElementById('rzp-button1').onclick = function(e) {
        rzp1.open();  // Open the payment modal
        e.preventDefault();  // Prevent default button behavior (if any)
    }
</script>
{% endblock %}
