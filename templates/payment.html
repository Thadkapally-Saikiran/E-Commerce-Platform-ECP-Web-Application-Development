{% extends "base.html" %}
<!-- ğŸ“„ This template extends the base layout 'base.html', allowing reuse of common elements like header, footer, navigation, etc. -->

{% block head %}
    <!-- ğŸ§  HEAD SECTION -->
    <!-- ğŸ·ï¸ Set the HTML title of the page; this appears in the browser tab -->
    <title>Payment</title>
    
    <!-- ğŸ’³ Razorpay Checkout Script -->
    <!-- ğŸ”— Include the official Razorpay checkout script via CDN to enable payment processing -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- ğŸ¨ Link to external CSS for page-specific payment styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/payment.css') }}">
{% endblock %}

{% block content %}
<!-- ğŸ§¾ MAIN CONTENT SECTION -->

<!-- ğŸ§± Container for the payment section (styled via CSS) -->
<div class="payment-container">
    <!-- ğŸ§¾ Page heading for payment confirmation -->
    <h2>Confirm Your Payment</h2>
    
    <!-- ğŸ“¦ Product information dynamically inserted using Jinja2 variables -->
    <p><strong>ğŸ“¦Product:</strong> {{ product.name }}</p> <!-- ğŸ“¦ Show product name -->
    <p><strong>ğŸ”¢Quantity:</strong> {{ order.quantity }}</p> <!-- ğŸ”¢ Show number of items -->
    <p><strong>ğŸ’°Total Price:</strong> â‚¹{{ '%.2f'|format(order.total_price) }}</p> <!-- ğŸ’° Show formatted total price (2 decimals) -->
    <p><strong>ğŸ Shipping to:</strong> {{ order.address }}</p> <!-- ğŸ  Show delivery/shipping address -->

    <!-- ğŸ’¸ Button to trigger payment process -->
    <button id="rzp-button1" class="pay-btn">Pay Now</button> <!-- ğŸš€ User clicks this to open Razorpay modal -->
</div>

<!-- ğŸ’» JAVASCRIPT BLOCK: Razorpay integration -->
<script>
    // âš™ï¸ Define configuration options for Razorpay Checkout modal
    var options = {
        "key": "{{ razorpay_key }}",  // ğŸ”‘ Razorpay public API key from backend (used to authenticate frontend)
        
        // ğŸ’° Transaction amount in paise (multiply by 100 because Razorpay uses smallest currency unit)
        "amount": "{{ (order.total_price * 100)|int }}",  
        
        "currency": "INR",            // ğŸ‡®ğŸ‡³ Set currency to Indian Rupees
        
        "name": "My Store",           // ğŸª Business or brand name shown in the Razorpay modal
        
        "description": "Purchase of {{ product.name }} x {{ order.quantity }}",  
        // ğŸ“ Transaction description shown in modal (e.g., "Purchase of Smartphone x 2")
        
        "order_id": "{{ razorpay_order_id }}",  
        // ğŸ“¦ Unique Razorpay order ID generated on the backend to link frontend with backend

        "handler": function (response) {
            // ğŸ§© Callback function executed after a successful Razorpay payment
            
            var orderId = "{{ order.id }}";  // ğŸ†” Capture current order ID for reference
            
            // ğŸ“ Create a new <form> element dynamically to send payment details to backend securely
            var form = document.createElement("form");
            form.method = "POST";            // ğŸ“® Use POST method to avoid exposing data in URL
            form.action = "/payment_success/" + orderId;  // ğŸ“ Endpoint that handles successful payments

            // ğŸ“¤ Prepare key Razorpay payment details to be sent
            var inputs = {
                "razorpay_payment_id": response.razorpay_payment_id,     // ğŸ§¾ Unique payment ID
                "razorpay_order_id": response.razorpay_order_id,         // ğŸ” Order ID matched with backend
                "razorpay_signature": response.razorpay_signature        // ğŸ” Signature used to verify payment integrity
            };

            // ğŸ”’ Loop through each key-value pair to generate hidden input fields in the form
            for (var key in inputs) {
                var input = document.createElement("input"); // ğŸ§± Create <input> element
                input.type = "hidden";                        // ğŸ™ˆ Hide input from UI
                input.name = key;                             // ğŸ·ï¸ Assign name to input
                input.value = inputs[key];                    // ğŸ’¾ Assign actual value
                form.appendChild(input);                      // â• Add input to the form
            }

            // ğŸ“¦ Add form to the document body and auto-submit it to backend
            document.body.appendChild(form);  // ğŸ—ï¸ Append form to DOM
            form.submit();                    // ğŸš€ Automatically submit to server for final verification
        }
    };

    // ğŸ†• Create Razorpay instance using defined options
    var rzp1 = new Razorpay(options);
    
    // ğŸ§  Attach a click event to the "Pay Now" button
    document.getElementById('rzp-button1').onclick = function(e) {
        rzp1.open();  // ğŸªŸ Open Razorpay payment popup/modal
        e.preventDefault();  // ğŸš« Prevent default form submission or page reload
    }
</script>
{% endblock %}
